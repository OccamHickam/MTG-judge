<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Veritas - Coach Mode</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0a0f1a 0%, #1a1f2e 100%);
            color: #e2e8f0;
            min-height: 100vh;
            overflow: hidden;
            position: relative;
        }
        
        /* Ambient listening indicator */
        .ambient-indicator {
            position: fixed;
            top: 30px;
            right: 30px;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #14b8a6;
            opacity: 0.3;
            animation: ambientPulse 3s infinite;
        }
        @keyframes ambientPulse {
            0%, 100% { opacity: 0.2; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
        }
        
        .back-link {
            position: fixed;
            top: 30px;
            left: 30px;
            color: #64748b;
            text-decoration: none;
            font-size: 0.9rem;
            opacity: 0.5;
            transition: opacity 0.3s;
        }
        .back-link:hover { opacity: 1; color: #14b8a6; }
        
        /* Veritas character - hidden by default */
        .veritas-container {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(200px);
            opacity: 0;
            transition: all 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
            text-align: center;
            pointer-events: none;
        }
        .veritas-container.active {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
            pointer-events: auto;
        }
        
        .veritas-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, #14b8a6, #2dd4bf);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            margin: 0 auto 20px;
            box-shadow: 0 0 40px rgba(20, 184, 166, 0.4);
            animation: avatarFloat 3s ease-in-out infinite;
        }
        @keyframes avatarFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        .speech-bubble {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 20px;
            padding: 25px 30px;
            max-width: 600px;
            position: relative;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }
        .speech-bubble::before {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-top: 10px solid #1e293b;
        }
        .speech-bubble h3 {
            color: #14b8a6;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }
        .speech-bubble p {
            color: #94a3b8;
            line-height: 1.6;
            font-size: 1rem;
        }
        .speech-bubble .close-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            background: none;
            border: none;
            color: #64748b;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0;
        }
        .speech-bubble .close-btn:hover { color: #e2e8f0; }
        
        /* Coaching tips styling */
        .tip-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #334155;
        }
        .tip-section h4 {
            color: #2dd4bf;
            font-size: 0.9rem;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .tip-section ul {
            margin: 0;
            padding-left: 20px;
            color: #cbd5e1;
        }
        .tip-section li {
            margin-bottom: 6px;
            line-height: 1.5;
        }
        
        .transcript-toggle {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid #334155;
            color: #64748b;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.85rem;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .transcript-toggle.visible {
            opacity: 1;
        }
        .transcript-toggle:hover {
            color: #14b8a6;
            border-color: #14b8a6;
        }
        
        .transcript-drawer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(15, 23, 42, 0.95);
            border-top: 1px solid #334155;
            transform: translateY(100%);
            transition: transform 0.3s;
            max-height: 40vh;
            overflow-y: auto;
        }
        .transcript-drawer.open {
            transform: translateY(0);
        }
        .transcript-content {
            padding: 20px 30px;
        }
        .transcript-item {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #334155;
        }
        .transcript-item:last-child {
            border-bottom: none;
        }
        .transcript-time {
            color: #64748b;
            font-size: 0.8rem;
            margin-bottom: 5px;
        }
        .transcript-text {
            color: #e2e8f0;
        }
        .transcript-text.question {
            color: #14b8a6;
        }
        
        .end-session {
            position: fixed;
            bottom: 30px;
            left: 30px;
            background: rgba(220, 38, 38, 0.8);
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.85rem;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .end-session.visible {
            opacity: 1;
        }
        
        .summary-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            transform: translateY(100%);
            transition: transform 0.5s;
            overflow-y: auto;
            padding: 40px;
            z-index: 100;
        }
        .summary-screen.active {
            transform: translateY(0);
        }
        .summary-content {
            max-width: 800px;
            margin: 0 auto;
        }
        .summary-header {
            text-align: center;
            margin-bottom: 40px;
        }
        .summary-header h2 {
            color: #14b8a6;
            font-size: 2rem;
            margin-bottom: 10px;
        }
        .summary-header p {
            color: #64748b;
        }
        .coaching-card {
            background: #1e293b;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            border: 1px solid #334155;
        }
        .coaching-card h3 {
            color: #14b8a6;
            margin-bottom: 15px;
            font-size: 1.2rem;
        }
        .coaching-card p, .coaching-card li {
            color: #94a3b8;
            line-height: 1.6;
        }
        .coaching-card ul {
            padding-left: 20px;
        }
        .coaching-card li {
            margin-bottom: 8px;
        }
        .summary-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 40px;
        }
        .summary-actions button {
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 1rem;
        }
        .btn-secondary {
            background: #334155 !important;
            color: #e2e8f0 !important;
        }
    </style>
</head>
<body>
    <!-- Ambient indicator -->
    <div class="ambient-indicator" title="Veritas is listening"></div>
    
    <!-- Back link -->
    <a href="index.html" class="back-link">‚Üê Back</a>
    
    <!-- Veritas character -->
    <div class="veritas-container" id="veritas">
        <div class="veritas-avatar">‚öñÔ∏è</div>
        <div class="speech-bubble">
            <button class="close-btn" onclick="dismissVeritas()">√ó</button>
            <h3 id="veritas-title">Veritas</h3>
            <div id="veritas-content">
                <p>Listening for your strategic questions...</p>
            </div>
        </div>
    </div>
    
    <!-- Transcript toggle -->
    <button class="transcript-toggle" id="transcriptBtn" onclick="toggleTranscript()">üìù History</button>
    
    <!-- Transcript drawer -->
    <div class="transcript-drawer" id="transcriptDrawer">
        <div class="transcript-content" id="transcriptContent">
            <p style="color: #64748b; text-align: center;">Describe your game situation and I'll offer coaching...</p>
        </div>
    </div>
    
    <!-- End session -->
    <button class="end-session" id="endBtn" onclick="endSession()">End Session</button>
    
    <!-- Summary screen -->
    <div class="summary-screen" id="summaryScreen">
        <div class="summary-content">
            <div class="summary-header">
                <h2>üß† Coaching Session Summary</h2>
                <p>Strategic insights from your session</p>
            </div>
            
            <div id="summary-cards">
                <!-- Dynamically populated -->
            </div>
            
            <div class="summary-actions">
                <button class="btn-secondary" onclick="window.location.href='index.html'">‚Üê Back to Home</button>
                <button onclick="location.reload()">üß† New Coaching Session</button>
            </div>
        </div>
    </div>

    <script>
        let recognition = null;
        let isListening = true;
        let sessionData = {
            situations: [],
            advice: [],
            startTime: new Date()
        };
        let veritasVisible = false;
        let dismissTimeout = null;

        // Coaching patterns to detect strategic questions
        const coachingPatterns = [
            /should i/i, /do i/i, /can i/i, /is it right/i,
            /attack/i, /block/i, /trade/i, /hold/i, /wait/i,
            /play.*now/i, /cast.*now/i, /use.*ability/i,
            /what.*do/i, /how.*play/i, /strategy/i, /plan/i,
            /ahead/i, /behind/i, /winning/i, /losing/i,
            /life/i, /cards/i, /board/i, /mana/i, /resources/i
        ];

        // Strategic coaching database
        const coachingAdvice = {
            'attack': {
                title: '‚öîÔ∏è Combat Decision',
                quick: 'Consider: Can they profitably block? What removal might they have? Are you the beatdown?',
                detailed: [
                    'Count potential blockers and compare to your attackers',
                    'Consider combat tricks or removal they might have',
                    'Ask: "If I attack and they block optimally, who wins?"',
                    'If you\'re ahead, force trades. If behind, hold back blockers.'
                ]
            },
            'block': {
                title: 'üõ°Ô∏è Blocking Strategy',
                quick: 'Block to preserve life or trade efficiently. Don\'t chump block unless necessary.',
                detailed: [
                    'Trade your worse creatures for their better ones',
                    'Preserve creatures with evasion or high value',
                    'Consider: "Will I need this blocker later?"',
                    'Sometimes taking damage is better than losing a key creature'
                ]
            },
            'trade': {
                title: '‚öñÔ∏è Trading Resources',
                quick: 'Trade when your card is worse than theirs, or when you\'re ahead and want to simplify.',
                detailed: [
                    'Trade up: your 2/2 for their 3/3 is winning',
                    'Don\'t trade your only flyer if they have bigger ground creatures',
                    'When ahead, trade to reduce variance. When behind, avoid trades and seek 2-for-1s',
                    'Consider the quality of cards remaining in each deck'
                ]
            },
            'resources': {
                title: 'üìä Resource Management',
                quick: 'Count cards, life, and mana. Who has more total resources?',
                detailed: [
                    'Card advantage: Who will run out of playable spells first?',
                    'Tempo: Who dictates the pace of the game?',
                    'Mana efficiency: Are you using all your mana each turn?',
                    'Life total: Is it a resource to spend or protect?'
                ]
            },
            'plan': {
                title: 'üéØ Strategic Planning',
                quick: 'What\'s your path to victory? Play toward that plan.',
                detailed: [
                    'Identify your win condition (aggro, combo, control, value)',
                    'Determine if you\'re the aggressor or defender',
                    'Sequence your plays to maximize pressure or disruption',
                    'Anticipate their best responses and have backup plans'
                ]
            },
            'ahead': {
                title: 'üèÜ Playing From Ahead',
                quick: 'Protect your advantage. Force trades, reduce variance, close out quickly.',
                detailed: [
                    'Don\'t get greedy ‚Äî secure the win',
                    'Force trades to reduce their comeback potential',
                    'Hold removal for their best threats',
                    'Watch for sweepers and overextending'
                ]
            },
            'behind': {
                title: 'üîÑ Playing From Behind',
                quick: 'Seek 2-for-1s, play to your outs, and force them to have answers.',
                detailed: [
                    'Take calculated risks ‚Äî you need to change the game state',
                    'Play to your specific outs (topdeck threats, synergies)',
                    'Bluff confidence to pressure their decisions',
                    'Consider unconventional lines they might not expect'
                ]
            },
            'default': {
                title: 'üß† Strategic Analysis',
                quick: 'Analyze resources, identify who\'s ahead, and play to your win condition.',
                detailed: [
                    'Assess: life totals, cards in hand, board state, graveyards',
                    'Determine: Are you beatdown or control in this matchup?',
                    'Plan: What sequence of plays maximizes your win probability?',
                    'Adapt: Respond to new information and shifting game states'
                ]
            }
        };

        // Initialize speech recognition
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = 'en-US';

            recognition.onresult = (event) => {
                const results = event.results;
                const lastResult = results[results.length - 1];
                const transcript = lastResult[0].transcript;
                
                if (lastResult.isFinal) {
                    processTranscript(transcript);
                }
            };

            recognition.onerror = (event) => {
                if (event.error === 'no-speech') return;
                console.error('Error:', event.error);
                setTimeout(() => { if (isListening) recognition.start(); }, 1000);
            };

            recognition.onend = () => {
                if (isListening) recognition.start();
            };

            recognition.start();
            
            setTimeout(() => {
                document.getElementById('transcriptBtn').classList.add('visible');
                document.getElementById('endBtn').classList.add('visible');
            }, 2000);
        } else {
            alert('Speech recognition not supported. Use Chrome or Edge.');
        }

        function processTranscript(text) {
            const timestamp = new Date().toLocaleTimeString();
            const entry = { time: timestamp, text: text, isSituation: false };
            
            const isCoachingRequest = coachingPatterns.some(pattern => pattern.test(text));
            
            if (isCoachingRequest) {
                entry.isSituation = true;
                sessionData.situations.push(entry);
                
                const advice = generateAdvice(text);
                sessionData.advice.push(advice);
                showVeritas(advice);
            }
            
            updateTranscript(entry);
        }

        function generateAdvice(text) {
            const lower = text.toLowerCase();
            let key = 'default';
            
            if (lower.includes('attack') || lower.includes('swing')) key = 'attack';
            else if (lower.includes('block')) key = 'block';
            else if (lower.includes('trade')) key = 'trade';
            else if (lower.includes('mana') || lower.includes('cards') || lower.includes('life')) key = 'resources';
            else if (lower.includes('plan') || lower.includes('strategy') || lower.includes('do')) key = 'plan';
            else if (lower.includes('ahead') || lower.includes('winning')) key = 'ahead';
            else if (lower.includes('behind') || lower.includes('losing')) key = 'behind';
            
            return coachingAdvice[key];
        }

        function showVeritas(advice) {
            clearTimeout(dismissTimeout);
            
            document.getElementById('veritas-title').textContent = advice.title;
            
            let content = `<p>${advice.quick}</p>`;
            if (advice.detailed) {
                content += `<div class="tip-section"><h4>Key Considerations</h4><ul>`;
                advice.detailed.forEach(tip => {
                    content += `<li>${tip}</li>`;
                });
                content += `</ul></div>`;
            }
            
            document.getElementById('veritas-content').innerHTML = content;
            document.getElementById('veritas').classList.add('active');
            veritasVisible = true;
            
            dismissTimeout = setTimeout(() => {
                if (!document.querySelector('.veritas-container:hover')) {
                    dismissVeritas();
                }
            }, 12000);
        }

        function dismissVeritas() {
            document.getElementById('veritas').classList.remove('active');
            veritasVisible = false;
        }

        function updateTranscript(entry) {
            const content = document.getElementById('transcriptContent');
            if (content.innerHTML.includes('Describe your game')) {
                content.innerHTML = '';
            }
            
            const div = document.createElement('div');
            div.className = 'transcript-item';
            div.innerHTML = `
                <div class="transcript-time">${entry.time}</div>
                <div class="transcript-text ${entry.isSituation ? 'question' : ''}">${entry.text}</div>
            `;
            content.insertBefore(div, content.firstChild);
        }

        function toggleTranscript() {
            document.getElementById('transcriptDrawer').classList.toggle('open');
        }

        function endSession() {
            isListening = false;
            if (recognition) recognition.stop();
            
            const duration = Math.floor((new Date() - sessionData.startTime) / 1000);
            const minutes = Math.floor(duration / 60);
            const seconds = duration % 60;
            
            let summaryHTML = `
                <div class="coaching-card">
                    <h3>‚è±Ô∏è Session Duration</h3>
                    <p>${minutes}:${seconds.toString().padStart(2, '0')}</p>
                </div>
                <div class="coaching-card">
                    <h3>üéØ Situations Analyzed</h3>
                    <p>${sessionData.situations.length} strategic questions addressed</p>
                </div>
            `;
            
            if (sessionData.advice.length > 0) {
                const adviceCounts = {};
                sessionData.advice.forEach(a => {
                    adviceCounts[a.title] = (adviceCounts[a.title] || 0) + 1;
                });
                
                summaryHTML += `<div class="coaching-card"><h3>üìä Topics Covered</h3><ul>`;
                for (const [title, count] of Object.entries(adviceCounts)) {
                    summaryHTML += `<li>${title}: ${count} time${count > 1 ? 's' : ''}</li>`;
                }
                summaryHTML += `</ul></div>`;
            }
            
            summaryHTML += `
                <div class="coaching-card">
                    <h3>üí° Remember</h3>
                    <p>Good Magic is about making the best decisions with available information. Review your games to identify patterns in your play.</p>
                </div>
            `;
            
            document.getElementById('summary-cards').innerHTML = summaryHTML;
            
            let sessions = JSON.parse(localStorage.getItem('veritas_coaching') || '[]');
            sessions.push({
                ...sessionData,
                endTime: new Date().toISOString(),
                duration: duration
            });
            localStorage.setItem('veritas_coaching', JSON.stringify(sessions));
            
            document.getElementById('summaryScreen').classList.add('active');
        }
    </script>
</body>
</html>
