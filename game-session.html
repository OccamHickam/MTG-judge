<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Veritas - Game Session</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0a0f1a 0%, #1a1f2e 50%, #0f172a 100%);
            color: #e2e8f0;
            min-height: 100vh;
            overflow: hidden;
            position: relative;
        }
        
        /* Animated background particles */
        .particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: hidden;
            z-index: 0;
        }
        
        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: rgba(20, 184, 166, 0.6);
            border-radius: 50%;
            animation: float 15s infinite;
            box-shadow: 0 0 10px rgba(20, 184, 166, 0.4);
        }
        
        .particle:nth-child(1) { left: 10%; animation-delay: 0s; animation-duration: 12s; }
        .particle:nth-child(2) { left: 20%; animation-delay: 1s; animation-duration: 18s; width: 6px; height: 6px; }
        .particle:nth-child(3) { left: 30%; animation-delay: 2s; animation-duration: 14s; }
        .particle:nth-child(4) { left: 40%; animation-delay: 0.5s; animation-duration: 16s; width: 3px; height: 3px; background: rgba(45, 212, 191, 0.5); }
        .particle:nth-child(5) { left: 50%; animation-delay: 3s; animation-duration: 20s; width: 5px; height: 5px; }
        .particle:nth-child(6) { left: 60%; animation-delay: 1.5s; animation-duration: 13s; }
        .particle:nth-child(7) { left: 70%; animation-delay: 2.5s; animation-duration: 17s; width: 4px; height: 4px; background: rgba(20, 184, 166, 0.4); }
        .particle:nth-child(8) { left: 80%; animation-delay: 0s; animation-duration: 19s; width: 6px; height: 6px; }
        .particle:nth-child(9) { left: 90%; animation-delay: 4s; animation-duration: 15s; }
        .particle:nth-child(10) { left: 15%; animation-delay: 2s; animation-duration: 21s; width: 3px; height: 3px; background: rgba(45, 212, 191, 0.6); }
        .particle:nth-child(11) { left: 25%; animation-delay: 5s; animation-duration: 14s; }
        .particle:nth-child(12) { left: 35%; animation-delay: 1s; animation-duration: 18s; width: 5px; height: 5px; }
        .particle:nth-child(13) { left: 45%; animation-delay: 3.5s; animation-duration: 16s; }
        .particle:nth-child(14) { left: 55%; animation-delay: 0.5s; animation-duration: 20s; width: 4px; height: 4px; background: rgba(20, 184, 166, 0.5); }
        .particle:nth-child(15) { left: 65%; animation-delay: 4.5s; animation-duration: 13s; }
        .particle:nth-child(16) { left: 75%; animation-delay: 2.5s; animation-duration: 17s; width: 6px; height: 6px; }
        .particle:nth-child(17) { left: 85%; animation-delay: 1s; animation-duration: 19s; }
        .particle:nth-child(18) { left: 5%; animation-delay: 3s; animation-duration: 15s; width: 3px; height: 3px; }
        .particle:nth-child(19) { left: 95%; animation-delay: 0s; animation-duration: 22s; width: 5px; height: 5px; background: rgba(45, 212, 191, 0.4); }
        .particle:nth-child(20) { left: 50%; animation-delay: 6s; animation-duration: 14s; }
        
        @keyframes float {
            0% {
                transform: translateY(100vh) rotate(0deg);
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            90% {
                opacity: 1;
            }
            100% {
                transform: translateY(-100vh) rotate(720deg);
                opacity: 0;
            }
        }
        
        /* Additional ambient glow */
        .ambient-glow {
            position: fixed;
            width: 300px;
            height: 300px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(20, 184, 166, 0.15) 0%, transparent 70%);
            pointer-events: none;
            animation: drift 20s infinite ease-in-out;
        }
        
        .ambient-glow:nth-child(1) {
            top: 20%;
            left: 20%;
            animation-delay: 0s;
        }
        
        .ambient-glow:nth-child(2) {
            top: 60%;
            right: 20%;
            animation-delay: -10s;
            background: radial-gradient(circle, rgba(45, 212, 191, 0.1) 0%, transparent 70%);
        }
        
        @keyframes drift {
            0%, 100% {
                transform: translate(0, 0) scale(1);
            }
            25% {
                transform: translate(50px, -30px) scale(1.1);
            }
            50% {
                transform: translate(-30px, 50px) scale(0.9);
            }
            75% {
                transform: translate(-50px, -20px) scale(1.05);
            }
        }
        
        /* Recording state - particles turn red */
        body.recording .particle {
            background: rgba(239, 68, 68, 0.6);
            box-shadow: 0 0 10px rgba(239, 68, 68, 0.4);
        }
        
        body.recording .ambient-glow {
            background: radial-gradient(circle, rgba(239, 68, 68, 0.15) 0%, transparent 70%);
        }
        
        /* UI Elements */
        .back-link {
            position: fixed;
            top: 30px;
            left: 30px;
            color: #64748b;
            text-decoration: none;
            font-size: 0.9rem;
            opacity: 0.5;
            transition: opacity 0.3s;
            z-index: 10;
        }
        .back-link:hover { opacity: 1; color: #14b8a6; }
        
        /* Status indicator */
        .status-bar {
            position: fixed;
            top: 30px;
            right: 30px;
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 10;
            background: rgba(15, 23, 42, 0.8);
            padding: 8px 16px;
            border-radius: 20px;
            border: 1px solid #334155;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #22c55e;
            animation: statusPulse 2s infinite;
        }
        
        @keyframes statusPulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
        }
        
        body.recording .status-dot {
            background: #ef4444;
            animation: recordingPulse 1s infinite;
        }
        
        @keyframes recordingPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        
        .status-text {
            color: #64748b;
            font-size: 0.85rem;
        }
        
        /* Veritas character */
        .veritas-container {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(300px);
            opacity: 0;
            transition: all 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
            text-align: center;
            z-index: 10;
            pointer-events: none;
        }
        .veritas-container.active {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
            pointer-events: auto;
        }
        
        .veritas-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: linear-gradient(135deg, #14b8a6, #2dd4bf);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            margin: 0 auto 20px;
            box-shadow: 0 0 60px rgba(20, 184, 166, 0.5);
            animation: avatarFloat 3s ease-in-out infinite;
        }
        
        @keyframes avatarFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-15px); }
        }
        
        .speech-bubble {
            background: rgba(30, 41, 59, 0.95);
            border: 1px solid #334155;
            border-radius: 20px;
            padding: 25px 30px;
            max-width: 500px;
            position: relative;
            backdrop-filter: blur(10px);
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }
        
        .speech-bubble::before {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-top: 10px solid rgba(30, 41, 59, 0.95);
        }
        
        .speech-bubble h3 {
            color: #14b8a6;
            margin-bottom: 10px;
            font-size: 1.2rem;
        }
        
        .speech-bubble p {
            color: #94a3b8;
            line-height: 1.6;
        }
        
        .speech-bubble .close-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            background: none;
            border: none;
            color: #64748b;
            font-size: 1.2rem;
            cursor: pointer;
        }
        
        /* Transcript drawer */
        .transcript-toggle {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: rgba(30, 41, 59, 0.9);
            border: 1px solid #334155;
            color: #64748b;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 0.9rem;
            z-index: 10;
            backdrop-filter: blur(10px);
            transition: all 0.3s;
        }
        
        .transcript-toggle:hover {
            color: #14b8a6;
            border-color: #14b8a6;
        }
        
        .transcript-drawer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(15, 23, 42, 0.98);
            border-top: 1px solid #334155;
            transform: translateY(100%);
            transition: transform 0.3s;
            max-height: 50vh;
            overflow-y: auto;
            z-index: 20;
            backdrop-filter: blur(20px);
        }
        
        .transcript-drawer.open {
            transform: translateY(0);
        }
        
        .transcript-content {
            padding: 30px;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .transcript-item {
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #334155;
        }
        
        .transcript-time {
            color: #64748b;
            font-size: 0.8rem;
            margin-bottom: 5px;
        }
        
        .transcript-text {
            color: #e2e8f0;
            font-size: 1.1rem;
        }
        
        .transcript-text.question {
            color: #14b8a6;
        }
        
        /* End session */
        .end-session {
            position: fixed;
            bottom: 30px;
            left: 30px;
            background: rgba(220, 38, 38, 0.9);
            border: none;
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 0.9rem;
            z-index: 10;
            backdrop-filter: blur(10px);
            transition: all 0.3s;
        }
        
        .end-session:hover {
            background: rgba(220, 38, 38, 1);
            transform: translateY(-2px);
        }
        
        /* Summary screen */
        .summary-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            transform: translateY(100%);
            transition: transform 0.5s;
            overflow-y: auto;
            padding: 40px;
            z-index: 100;
        }
        
        .summary-screen.active {
            transform: translateY(0);
        }
        
        .summary-content {
            max-width: 800px;
            margin: 0 auto;
        }
        
        .summary-header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .summary-header h2 {
            color: #14b8a6;
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .summary-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .summary-stat {
            background: #1e293b;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid #334155;
        }
        
        .summary-stat-value {
            font-size: 2.5rem;
            color: #14b8a6;
            font-weight: bold;
        }
        
        .summary-stat-label {
            color: #64748b;
            margin-top: 5px;
        }
        
        .transcript-summary {
            background: #1e293b;
            border-radius: 12px;
            padding: 25px;
            border: 1px solid #334155;
            margin-bottom: 30px;
        }
        
        .transcript-summary h3 {
            color: #14b8a6;
            margin-bottom: 20px;
        }
        
        .summary-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
        }
        
        .summary-actions button {
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 1rem;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: linear-gradient(90deg, #14b8a6, #2dd4bf);
            color: #0f172a;
            font-weight: bold;
        }
        
        .btn-secondary {
            background: #334155;
            color: #e2e8f0;
        }
        
        /* Initial hint */
        .start-hint {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: #64748b;
            opacity: 0.7;
            pointer-events: none;
            z-index: 5;
        }
        
        .start-hint.hidden {
            opacity: 0;
            transition: opacity 0.5s;
        }
    </style>
</head>
<body>
    <!-- Animated background -->
    <div class="particles">
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
    </div>
    
    <div class="ambient-glow"></div>
    <div class="ambient-glow"></div>
    
    <!-- UI -->
    <a href="index.html" class="back-link">‚Üê Back</a>
    
    <div class="status-bar">
        <div class="status-dot"></div>
        <span class="status-text" id="statusText">Listening...</span>
    </div>
    
    <!-- Start hint -->
    <div class="start-hint" id="startHint">
        <p style="font-size: 1.2rem; margin-bottom: 10px;">üéôÔ∏è Veritas is listening</p>
        <p style="font-size: 0.9rem;">Ask a rules question to begin</p>
    </div>
    
    <!-- Veritas character -->
    <div class="veritas-container" id="veritas">
        <div class="veritas-avatar">‚öñÔ∏è</div>
        <div class="speech-bubble">
            <button class="close-btn" onclick="dismissVeritas()">√ó</button>
            <h3 id="veritas-title">Veritas</h3>
            <p id="veritas-message">Listening for your questions...</p>
        </div>
    </div>
    
    <!-- Controls -->
    <button class="transcript-toggle" onclick="toggleTranscript()">üìù History</button>
    
    <button class="end-session" onclick="endSession()">End Session</button>
    
    <!-- Transcript drawer -->
    <div class="transcript-drawer" id="transcriptDrawer">
        <div class="transcript-content" id="transcriptContent">
            <p style="color: #64748b; text-align: center;">Ask a question to see the transcript...</p>
        </div>
    </div>
    
    <!-- Summary screen -->
    <div class="summary-screen" id="summaryScreen">
        <div class="summary-content">
            <div class="summary-header">
                <h2>üß† Session Complete</h2>
                <p style="color: #64748b;">Here's what we covered</p>
            </div>
            
            <div class="summary-stats">
                <div class="summary-stat">
                    <div class="summary-stat-value" id="statQuestions">0</div>
                    <div class="summary-stat-label">Questions</div>
                </div>
                <div class="summary-stat">
                    <div class="summary-stat-value" id="statDuration">0:00</div>
                    <div class="summary-stat-label">Duration</div>
                </div>
                <div class="summary-stat">
                    <div class="summary-stat-value" id="statRules">0</div>
                    <div class="summary-stat-label">Rules Explained</div>
                </div>
            </div>
            
            <div class="transcript-summary">
                <h3>üìù Full Transcript</h3>
                <div id="summaryTranscript" style="color: #94a3b8; line-height: 1.6;">
                    <p>No questions asked during this session.</p>
                </div>
            </div>
            
            <div class="summary-actions">
                <button class="btn-secondary" onclick="window.location.href='index.html'">‚Üê Back to Home</button>
                <button class="btn-primary" onclick="location.reload()">üéÆ New Session</button>
            </div>
        </div>
    </div>

    <script>
        let recognition = null;
        let isListening = true;
        let sessionData = {
            transcript: [],
            questions: [],
            startTime: new Date(),
            rulesExplained: 0
        };
        let veritasVisible = false;
        let dismissTimeout = null;

        // Question patterns
        const questionPatterns = [
            /can i/i, /can you/i, /can we/i,
            /does/i, /do /i, /is /i, /are /i,
            /how does/i, /what happens/i, /what if/i,
            /wait/i, /hold on/i, /actually/i,
            /target/i, /respond/i, /trigger/i, /stack/i,
            /hexproof/i, /flying/i, /trample/i, /indestructible/i,
            /commander/i, /combat/i, /attack/i, /block/i
        ];

        // Rules database
        const rules = {
            'hexproof': 'Hexproof means this permanent can\'t be targeted by spells or abilities your opponents control. But it can still be affected by board wipes, sacrifice effects, or spells that don\'t target.',
            'trample': 'Trample lets excess combat damage spill over to the defending player. If a 5/5 with trample is blocked by a 2/2, 2 damage kills the blocker and 3 hits the player.',
            'flying': 'Flying creatures can only be blocked by other creatures with flying or reach. Ground creatures can\'t block them.',
            'indestructible': 'Indestructible means damage and "destroy" effects don\'t kill it. But it can still be exiled, sacrificed, or have its toughness reduced to 0.',
            'commander tax': 'Each time you cast your commander from the command zone after the first, it costs 2 more generic mana. This tax accumulates.',
            'commander damage': 'If a single commander deals 21 or more combat damage to you over the course of the game, you lose.',
            'the stack': 'Spells and abilities wait on the stack to resolve. Last one cast resolves first (LIFO). Players can respond before each resolution.',
            'priority': 'The active player gets priority first. When they pass, the non-active player can respond. Most actions use the stack.',
            'target': 'To target, you must choose a legal target when casting. Hexproof and shroud prevent targeting. Removing the target counters the spell.',
            'trigger': 'Triggers go on the stack when their condition is met. In multiplayer, APNAP order applies: Active Player, then Non-Active Players.'
        };

        // Initialize
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = 'en-US';

            recognition.onresult = (event) => {
                const results = event.results;
                const lastResult = results[results.length - 1];
                const transcript = lastResult[0].transcript;
                
                if (lastResult.isFinal) {
                    processTranscript(transcript);
                }
            };

            recognition.onerror = (event) => {
                if (event.error === 'no-speech') return;
                setTimeout(() => { if (isListening) recognition.start(); }, 1000);
            };

            recognition.onend = () => {
                if (isListening) recognition.start();
            };

            recognition.start();
        }

        function processTranscript(text) {
            const timestamp = new Date().toLocaleTimeString();
            const entry = { time: timestamp, text: text, isQuestion: false };
            
            const isQuestion = questionPatterns.some(pattern => pattern.test(text));
            
            if (isQuestion) {
                entry.isQuestion = true;
                sessionData.questions.push(entry);
                
                document.body.classList.add('recording');
                document.getElementById('statusText').textContent = 'Processing...';
                
                let answer = findAnswer(text);
                if (answer) {
                    sessionData.rulesExplained++;
                    showVeritas(answer.title, answer.text);
                } else {
                    showVeritas('Question Heard', `You asked: "${text}"\n\nIn the full version, I'll provide detailed rules analysis for this.`);
                }
                
                setTimeout(() => {
                    document.body.classList.remove('recording');
                    document.getElementById('statusText').textContent = 'Listening...';
                }, 2000);
                
                document.getElementById('startHint').classList.add('hidden');
            }
            
            sessionData.transcript.push(entry);
            updateTranscript();
        }

        function findAnswer(text) {
            const lower = text.toLowerCase();
            for (const [keyword, explanation] of Object.entries(rules)) {
                if (lower.includes(keyword)) {
                    return { title: keyword.charAt(0).toUpperCase() + keyword.slice(1), text: explanation };
                }
            }
            return null;
        }

        function showVeritas(title, message) {
            clearTimeout(dismissTimeout);
            
            document.getElementById('veritas-title').textContent = title;
            document.getElementById('veritas-message').textContent = message;
            document.getElementById('veritas').classList.add('active');
            veritasVisible = true;
            
            dismissTimeout = setTimeout(() => {
                if (!document.querySelector('.veritas-container:hover')) {
                    dismissVeritas();
                }
            }, 10000);
        }

        function dismissVeritas() {
            document.getElementById('veritas').classList.remove('active');
            veritasVisible = false;
        }

        function updateTranscript() {
            const content = document.getElementById('transcriptContent');
            if (content.innerHTML.includes('Ask a question')) {
                content.innerHTML = '';
            }
            
            const entry = sessionData.transcript[sessionData.transcript.length - 1];
            const div = document.createElement('div');
            div.className = 'transcript-item';
            div.innerHTML = `
                <div class="transcript-time">${entry.time}</div>
                <div class="transcript-text ${entry.isQuestion ? 'question' : ''}">${entry.text}</div>
            `;
            content.insertBefore(div, content.firstChild);
        }

        function toggleTranscript() {
            document.getElementById('transcriptDrawer').classList.toggle('open');
        }

        function endSession() {
            isListening = false;
            if (recognition) recognition.stop();
            
            const duration = Math.floor((new Date() - sessionData.startTime) / 1000);
            const minutes = Math.floor(duration / 60);
            const seconds = duration % 60;
            
            document.getElementById('statQuestions').textContent = sessionData.questions.length;
            document.getElementById('statDuration').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            document.getElementById('statRules').textContent = sessionData.rulesExplained;
            
            const summaryDiv = document.getElementById('summaryTranscript');
            if (sessionData.transcript.length > 0) {
                summaryDiv.innerHTML = sessionData.transcript.map(entry => `
                    <p style="margin-bottom: 10px; ${entry.isQuestion ? 'color: #14b8a6;' : ''}">
                        <strong>${entry.time}</strong> ${entry.text}
                    </p>
                `).join('');
            }
            
            let sessions = JSON.parse(localStorage.getItem('veritas_sessions') || '[]');
            sessions.push({
                ...sessionData,
                endTime: new Date().toISOString(),
                duration: duration
            });
            localStorage.setItem('veritas_sessions', JSON.stringify(sessions));
            
            document.getElementById('summaryScreen').classList.add('active');
        }
    </script>
</body>
</html>
