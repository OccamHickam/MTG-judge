<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Veritas - Game Session</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0a0a0f;
            color: #e0e0ff;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
        }

        #particle-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            pointer-events: none;
        }

        #game-session {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: radial-gradient(ellipse at center, rgba(20, 20, 40, 0.3) 0%, rgba(5, 5, 10, 0.9) 100%);
        }

        .listening-container {
            text-align: center;
            opacity: 0.6;
            transition: opacity 0.3s ease;
        }

        .listening-container.active {
            opacity: 1;
        }

        .listening-pulse {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(0, 167, 181, 0.3) 0%, transparent 70%);
            margin: 0 auto 30px;
            position: relative;
            animation: pulse 3s ease-in-out infinite;
        }

        .listening-pulse::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(0, 167, 181, 0.5) 0%, transparent 70%);
            animation: pulse 3s ease-in-out infinite 0.5s;
        }

        .listening-pulse::after {
            content: 'üéôÔ∏è';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 32px;
            filter: drop-shadow(0 0 10px rgba(0, 167, 181, 0.8));
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 0.6; }
            50% { transform: scale(1.1); opacity: 1; }
        }

        .listening-text {
            font-size: 18px;
            letter-spacing: 3px;
            text-transform: uppercase;
            color: #00a7b5;
            text-shadow: 0 0 20px rgba(0, 167, 181, 0.5);
            margin-bottom: 10px;
        }

        .listening-subtext {
            font-size: 14px;
            color: #4a5568;
            font-style: italic;
        }

        .end-session-btn {
            position: absolute;
            top: 40px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(10, 10, 15, 0.8);
            border: 2px solid #00a7b5;
            color: #00a7b5;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 2px;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            z-index: 10;
        }

        .end-session-btn:hover {
            background: #00a7b5;
            color: white;
        }

        .status-bar {
            position: absolute;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 30px;
            align-items: center;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: #4a5568;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #4a5568;
        }

        .status-dot.active {
            background: #00a7b5;
            box-shadow: 0 0 10px rgba(0, 167, 181, 0.8);
        }

        .debug-info {
            position: absolute;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            color: #4a5568;
            font-size: 12px;
            text-align: center;
        }

        /* RULING OVERLAY */
        #ruling-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(5, 5, 10, 0.98);
            z-index: 100;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding: 40px;
            backdrop-filter: blur(20px);
            overflow-y: auto;
        }

        #ruling-overlay.active {
            display: flex;
        }

        .ruling-header {
            text-align: center;
            margin-bottom: 30px;
            width: 100%;
        }

        .ruling-icon {
            font-size: 48px;
            margin-bottom: 15px;
            animation: iconPulse 2s ease-in-out infinite;
        }

        @keyframes iconPulse {
            0%, 100% { transform: scale(1); filter: drop-shadow(0 0 20px rgba(0, 167, 181, 0.5)); }
            50% { transform: scale(1.05); filter: drop-shadow(0 0 40px rgba(0, 167, 181, 0.8)); }
        }

        .ruling-announcement {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 4px;
            color: #c9a86a;
            margin-bottom: 10px;
        }

        .ruling-title {
            font-size: 32px;
            font-weight: 300;
            color: #e0e0ff;
            text-shadow: 0 0 30px rgba(0, 167, 181, 0.3);
        }

        /* QUESTION FORM */
        .question-form {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(0, 167, 181, 0.3);
            border-radius: 12px;
            padding: 30px;
            max-width: 600px;
            width: 100%;
            margin-bottom: 20px;
        }

        .arbiter-question {
            font-size: 20px;
            color: #00a7b5;
            margin-bottom: 20px;
            line-height: 1.6;
            font-style: italic;
        }

        .arbiter-question::before {
            content: '"';
            font-size: 30px;
            color: #c9a86a;
            margin-right: 5px;
        }

        .arbiter-question::after {
            content: '"';
            font-size: 30px;
            color: #c9a86a;
            margin-left: 5px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            color: #94a3b8;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        .input-group input,
        .input-group textarea {
            width: 100%;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(0, 167, 181, 0.3);
            border-radius: 8px;
            padding: 12px;
            color: #e0e0ff;
            font-size: 16px;
            font-family: inherit;
        }

        .input-group input:focus,
        .input-group textarea:focus {
            outline: none;
            border-color: #00a7b5;
        }

        .input-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .voice-input-btn {
            background: rgba(0, 167, 181, 0.1);
            border: 1px solid #00a7b5;
            color: #00a7b5;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
            transition: all 0.3s;
        }

        .voice-input-btn:hover {
            background: #00a7b5;
            color: white;
        }

        .voice-input-btn.recording {
            background: #ef4444;
            border-color: #ef4444;
            color: white;
            animation: pulse 1s infinite;
        }

        .submit-btn {
            background: #00a7b5;
            border: none;
            color: #0a0a0f;
            padding: 15px 40px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s;
        }

        .submit-btn:hover {
            background: #008a99;
        }

        .submit-btn:disabled {
            background: #4a5568;
            cursor: not-allowed;
        }

        /* CARD DISPLAY */
        .card-display {
            display: flex;
            gap: 30px;
            align-items: flex-start;
            max-width: 900px;
            width: 100%;
            margin-bottom: 30px;
        }

        .card-image-container {
            flex-shrink: 0;
            width: 250px;
            height: 350px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 12px;
            border: 2px solid rgba(0, 167, 181, 0.3);
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .card-image {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .card-placeholder {
            color: #4a5568;
            font-size: 14px;
            text-align: center;
        }

        .ruling-content {
            flex: 1;
            text-align: left;
        }

        .card-name {
            font-size: 28px;
            color: #00a7b5;
            margin-bottom: 10px;
            font-weight: 500;
        }

        .arbiter-dialogue {
            background: rgba(0, 167, 181, 0.1);
            border-left: 4px solid #00a7b5;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 0 8px 8px 0;
            font-style: italic;
            color: #e0e0ff;
            line-height: 1.6;
        }

        .arbiter-dialogue::before {
            content: '"';
            font-size: 40px;
            color: #00a7b5;
            float: left;
            margin-right: 10px;
            line-height: 1;
        }

        .ruling-section {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(0, 167, 181, 0.2);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
        }

        .ruling-section h3 {
            color: #c9a86a;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 10px;
        }

        .ruling-section p {
            color: #8892b0;
            line-height: 1.6;
        }

        .official-rulings {
            max-height: 200px;
            overflow-y: auto;
        }

        .ruling-item {
            padding: 10px;
            margin-bottom: 8px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 6px;
            border-left: 3px solid #c9a86a;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(0, 167, 181, 0.3);
            border-top-color: #00a7b5;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .ruling-close {
            margin-top: 20px;
            padding: 15px 40px;
            background: transparent;
            border: 2px solid #00a7b5;
            color: #00a7b5;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 2px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 25px;
        }

        .ruling-close:hover {
            background: #00a7b5;
            color: white;
        }

        .step-indicator {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .step-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #4a5568;
            transition: all 0.3s;
        }

        .step-dot.active {
            background: #00a7b5;
            box-shadow: 0 0 10px rgba(0, 167, 181, 0.5);
        }

        .step-dot.complete {
            background: #c9a86a;
        }
    </style>
</head>
<body>
    <canvas id="particle-canvas"></canvas>

    <button class="end-session-btn" onclick="endSession()">End Session & Analyze</button>

    <div id="game-session">
        <div class="listening-container active" id="listening-container">
            <div class="listening-pulse"></div>
            <div class="listening-text">Listening</div>
            <div class="listening-subtext">The Arbiter hears all</div>
        </div>

        <div class="debug-info" id="debug-info">Session time: 0:00 | Disputes: 0</div>

        <div class="status-bar">
            <div class="status-item">
                <div class="status-dot active" id="mic-status"></div>
                <span>Microphone Active</span>
            </div>
        </div>
    </div>

    <!-- RULING OVERLAY -->
    <div id="ruling-overlay">
        <div class="ruling-header">
            <div class="ruling-icon">‚öñÔ∏è</div>
            <div class="ruling-announcement" id="overlay-subtitle">A disturbance ripples through the aether</div>
            <div class="ruling-title" id="overlay-title">Dispute Detected</div>
        </div>

        <div class="step-indicator" id="step-indicator" style="display: none;">
            <div class="step-dot active" id="step-1"></div>
            <div class="step-dot" id="step-2"></div>
            <div class="step-dot" id="step-3"></div>
        </div>

        <div id="overlay-content">
            <!-- Dynamic content goes here -->
        </div>
    </div>

    <script>
        // ============================================
        // SESSION DATA
        // ============================================
        window.sessionData = {
            startTime: new Date().toISOString(),
            endTime: null,
            players: ['Player 1', 'Player 2', 'Player 3', 'Player 4'],
            events: [],
            disputes: [],
            winner: 'Unknown'
        };

        let disputeCount = 0;
        let recognition;
        let currentDispute = null;
        let questionRecognition = null;

        // ============================================
        // TIMER & DEBUG INFO
        // ============================================
        function updateDebugInfo() {
            const elapsed = Math.floor((new Date() - new Date(window.sessionData.startTime)) / 1000);
            const mins = Math.floor(elapsed / 60);
            const secs = elapsed % 60;
            document.getElementById('debug-info').textContent = 
                `Session time: ${mins}:${secs.toString().padStart(2, '0')} | Disputes: ${disputeCount}`;
        }
        
        setInterval(updateDebugInfo, 1000);
        updateDebugInfo();

        // ============================================
        // END SESSION
        // ============================================
        function endSession() {
            window.sessionData.endTime = new Date().toISOString();
            window.sessionData.gameLength = Math.floor((new Date() - new Date(window.sessionData.startTime)) / 1000);
            
            localStorage.setItem('veritas_session', JSON.stringify(window.sessionData));
            
            if (recognition) recognition.stop();
            window.location.href = 'analysis.html';
        }

        // ============================================
        // DISPUTE DETECTION
        // ============================================
        class DisputeDetector {
            constructor() {
                this.lastTriggerTime = 0;
                this.cooldown = 5000;
                this.triggers = {
                    uncertainty: ['wait', 'hold on', 'does that', 'can you', 'not sure', 'confused', 'question'],
                    challenge: ["you can't", 'you cannot', 'illegal', 'wrong', 'not legal', 'invalid', 'cheat'],
                    mtg_terms: ['target', 'stack', 'priority', 'trigger', 'combat', 'phase', 'cast', 'destroy', 'counter']
                };
                this.weights = { uncertainty: 2, challenge: 3, mtg_terms: 1 };
            }

            analyze(text) {
                const lowerText = text.toLowerCase();
                let score = 0;

                for (const [category, words] of Object.entries(this.triggers)) {
                    for (const word of words) {
                        if (lowerText.includes(word)) score += this.weights[category];
                    }
                }

                const now = Date.now();
                if (score >= 3 && (now - this.lastTriggerTime) > this.cooldown) {
                    this.lastTriggerTime = now;
                    return { detected: true, text: text };
                }
                return { detected: false };
            }
        }

        const detector = new DisputeDetector();

        // ============================================
        // SHOW QUESTION FORM (STEP 1)
        // ============================================
        function showQuestionForm(initialText) {
            currentDispute = {
                initialText: initialText,
                cardName: '',
                situation: '',
                timestamp: new Date().toISOString()
            };

            document.getElementById('ruling-overlay').classList.add('active');
            document.getElementById('step-indicator').style.display = 'flex';
            updateSteps(1);

            const content = document.getElementById('overlay-content');
            content.innerHTML = `
                <div class="question-form">
                    <div class="arbiter-question">
                        A dispute has been detected. Before I render judgment, 
                        I must understand the nature of your question. Speak clearly, planeswalker.
                    </div>
                    
                    <div class="input-group">
                        <label>What card are you asking about? (Required)</label>
                        <input type="text" id="card-input" placeholder="e.g., Sol Ring, Counterspell, Lightning Bolt">
                        <button class="voice-input-btn" id="voice-card-btn" onclick="startVoiceInput('card')">
                            üé§ Speak Card Name
                        </button>
                    </div>

                    <div class="input-group">
                        <label>Describe the situation (Optional but helpful)</label>
                        <textarea id="situation-input" placeholder="e.g., My opponent tried to destroy my creature during my turn..."></textarea>
                        <button class="voice-input-btn" id="voice-sit-btn" onclick="startVoiceInput('situation')">
                            üé§ Describe Situation
                        </button>
                    </div>

                    <button class="submit-btn" onclick="submitQuestion()">
                        Consult the Arbiter
                    </button>
                </div>
            `;

            // Speak the question
            speak("A dispute has been detected. What card are you asking about?");
        }

        // ============================================
        // VOICE INPUT FOR FORM
        // ============================================
        function startVoiceInput(field) {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                alert('Voice input not supported');
                return;
            }

            const btn = document.getElementById(field === 'card' ? 'voice-card-btn' : 'voice-sit-btn');
            btn.classList.add('recording');
            btn.textContent = 'üî¥ Listening...';

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            questionRecognition = new SpeechRecognition();
            questionRecognition.lang = 'en-US';
            questionRecognition.interimResults = false;
            questionRecognition.maxAlternatives = 1;

            questionRecognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                const input = document.getElementById(field === 'card' ? 'card-input' : 'situation-input');
                input.value = transcript;
                btn.classList.remove('recording');
                btn.textContent = 'üé§ ' + (field === 'card' ? 'Speak Card Name' : 'Describe Situation');
            };

            questionRecognition.onerror = () => {
                btn.classList.remove('recording');
                btn.textContent = 'üé§ ' + (field === 'card' ? 'Speak Card Name' : 'Describe Situation');
            };

            questionRecognition.onend = () => {
                btn.classList.remove('recording');
                btn.textContent = 'üé§ ' + (field === 'card' ? 'Speak Card Name' : 'Describe Situation');
            };

            questionRecognition.start();
        }

        // ============================================
        // SUBMIT QUESTION & SEARCH (STEP 2)
        // ============================================
        async function submitQuestion() {
            const cardName = document.getElementById('card-input').value.trim();
            const situation = document.getElementById('situation-input').value.trim();

            if (!cardName) {
                alert('Please provide a card name');
                return;
            }

            currentDispute.cardName = cardName;
            currentDispute.situation = situation;

            // Show loading
            updateSteps(2);
            const content = document.getElementById('overlay-content');
            content.innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <div class="loading-spinner"></div>
                    <p style="color: #4a5568; margin-top: 20px;">
                        The Arbiter searches the infinite archives for ${cardName}...
                    </p>
                </div>
            `;

            // Search Scryfall
            const cardData = await searchCard(cardName);
            currentDispute.cardData = cardData;

            if (cardData) {
                const rulings = await getCardRulings(cardData.id);
                currentDispute.rulings = rulings;
                showRulingResult(cardData, rulings);
            } else {
                showNotFoundResult(cardName);
            }

            // Save to session
            window.sessionData.disputes.push(currentDispute);
            disputeCount++;
            updateDebugInfo();
        }

        // ============================================
        // SCRYFALL API
        // ============================================
        async function searchCard(cardName) {
            try {
                const response = await fetch(`https://api.scryfall.com/cards/named?fuzzy=${encodeURIComponent(cardName)}`);
                if (!response.ok) throw new Error('Card not found');
                return await response.json();
            } catch (error) {
                console.error('Scryfall search failed:', error);
                return null;
            }
        }

        async function getCardRulings(cardId) {
            try {
                const response = await fetch(`https://api.scryfall.com/cards/${cardId}/rulings`);
                if (!response.ok) throw new Error('No rulings found');
                const data = await response.json();
                return data.data || [];
            } catch (error) {
                return [];
            }
        }

        // ============================================
        // SHOW RULING RESULT (STEP 3)
        // ============================================
        function showRulingResult(cardData, rulings) {
            updateSteps(3);
            document.getElementById('overlay-title').textContent = 'The Law Has Been Determined';

            const dialogue = generateArbiterDialogue(cardData.name);

            let html = `
                <div class="card-display">
                    <div class="card-image-container">
                        ${cardData.image_uris ? 
                            `<img src="${cardData.image_uris.normal}" class="card-image" alt="${cardData.name}">` :
                            `<div class="card-placeholder">No image available</div>`
                        }
                    </div>
                    
                    <div class="ruling-content">
                        <div class="arbiter-dialogue">${dialogue.opener} ${dialogue.explanation}</div>
                        
                        <div class="card-name">${cardData.name}</div>
                        
                        <div class="ruling-section">
                            <h3>Oracle Text</h3>
                            <p>${cardData.oracle_text || 'No oracle text available.'}</p>
                        </div>
            `;

            if (rulings.length > 0) {
                html += `
                    <div class="ruling-section">
                        <h3>Relevant Rulings</h3>
                        <div class="official-rulings">
                `;
                rulings.slice(0, 3).forEach(ruling => {
                    html += `<div class="ruling-item">${ruling.comment}</div>`;
                });
                html += `</div></div>`;
            }

            if (currentDispute.situation) {
                html += `
                    <div class="ruling-section">
                        <h3>Regarding Your Situation</h3>
                        <p>Based on your description: "${currentDispute.situation}" - 
                        The Arbiter notes that ${cardData.name} ${getContextualAdvice(cardData)}</p>
                    </div>
                `;
            }

            html += `
                        <div class="arbiter-dialogue" style="border-left-color: #c9a86a; background: rgba(201, 168, 106, 0.1);">
                            ${dialogue.closer}
                        </div>
                    </div>
                </div>
                
                <button class="ruling-close" onclick="closeRuling()">The Stack Resolves. Continue.</button>
            `;

            document.getElementById('overlay-content').innerHTML = html;
            speak(dialogue.opener + " " + dialogue.explanation);
        }

        function showNotFoundResult(cardName) {
            updateSteps(3);
            document.getElementById('overlay-title').textContent = 'The Archives Are Unclear';

            const content = document.getElementById('overlay-content');
            content.innerHTML = `
                <div class="question-form" style="text-align: center;">
                    <div class="arbiter-dialogue">
                        I have searched the blind eternities but cannot find "${cardName}" 
                        in the comprehensive rules. Perhaps the name was spoken unclearly?
                    </div>
                    
                    <p style="color: #8892b0; margin: 20px 0;">
                        Try asking again with the exact card name, or consult the printed text on the card itself.
                    </p>

                    <button class="submit-btn" onclick="showQuestionForm(currentDispute.initialText)" style="margin-bottom: 10px;">
                        Try Again
                    </button>
                    <br>
                    <button class="ruling-close" onclick="closeRuling()">Continue Without Ruling</button>
                </div>
            `;
        }

        // ============================================
        // HELPER FUNCTIONS
        // ============================================
        function updateSteps(step) {
            for (let i = 1; i <= 3; i++) {
                const dot = document.getElementById(`step-${i}`);
                dot.classList.remove('active', 'complete');
                if (i === step) dot.classList.add('active');
                else if (i < step) dot.classList.add('complete');
            }
        }

        function generateArbiterDialogue(cardName) {
            const openers = [
                "The threads of fate have brought this matter before me.",
                "I have gazed into the aether and the Law is clear.",
                "Your dispute echoes across the planes. Hear now my judgment.",
                "The scales tip toward clarity. Listen well."
            ];
            const explanations = [
                `The card ${cardName} operates within the comprehensive rules as follows.`,
                `The mechanics of ${cardName} are bound by these principles.`,
                `This Arbiter has consulted the ancient texts regarding ${cardName}.`
            ];
            const closers = [
                "The stack resolves. Continue your game.",
                "May this knowledge guide your path to victory.",
                "The Law has spoken. Play on."
            ];

            return {
                opener: openers[Math.floor(Math.random() * openers.length)],
                explanation: explanations[Math.floor(Math.random() * explanations.length)],
                closer: closers[Math.floor(Math.random() * closers.length)]
            };
        }

        function getContextualAdvice(cardData) {
            // Simple contextual advice based on card type
            if (cardData.type_line.includes('Instant')) return 'can be cast at instant speed, even during your opponent\'s turn.';
            if (cardData.type_line.includes('Creature')) return 'enters the battlefield following the stack resolution rules.';
            if (cardData.type_line.includes('Sorcery')) return 'can only be cast during your main phase when the stack is empty.';
            return 'operates according to its printed text and the comprehensive rules.';
        }

        function speak(text) {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.rate = 0.8;
                utterance.pitch = 0.9;
                speechSynthesis.speak(utterance);
            }
        }

        function closeRuling() {
            document.getElementById('ruling-overlay').classList.remove('active');
            document.getElementById('step-indicator').style.display = 'none';
            document.getElementById('overlay-title').textContent = 'Dispute Detected';
            currentDispute = null;
        }

        // ============================================
        // MAIN SPEECH RECOGNITION
        // ============================================
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = 'en-US';

            recognition.onstart = () => {
                document.getElementById('listening-container').classList.add('active');
            };

            recognition.onend = () => {
                document.getElementById('listening-container').classList.remove('active');
                setTimeout(() => recognition.start(), 100);
            };

            recognition.onresult = (event) => {
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        console.log('Heard:', transcript);
                        const result = detector.analyze(transcript);
                        if (result.detected && !document.getElementById('ruling-overlay').classList.contains('active')) {
                            showQuestionForm(transcript);
                        }
                    }
                }
            };

            recognition.onerror = (e) => {
                setTimeout(() => recognition.start(), 1000);
            };

            recognition.start();
        }

        // ============================================
        // PARTICLE SYSTEM
        // ============================================
        const canvas = document.getElementById('particle-canvas');
        const ctx = canvas.getContext('2d');
        let particles = [];

        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }

        class Particle {
            constructor() {
                this.x = Math.random() * canvas.width;
                this.y = Math.random() * canvas.height;
                this.size = Math.random() * 2 + 0.5;
                this.speedX = (Math.random() - 0.5) * 0.5;
                this.speedY = (Math.random() - 0.5) * 0.5;
                this.opacity = Math.random() * 0.5 + 0.1;
                this.color = Math.random() > 0.5 ? '#00a7b5' : '#c9a86a';
            }
            update() {
                this.x += this.speedX;
                this.y += this.speedY;
                if (this.x < 0 || this.x > canvas.width || this.y < 0 || this.y > canvas.height) {
                    this.reset();
                }
            }
            reset() {
                this.x = Math.random() * canvas.width;
                this.y = Math.random() * canvas.height;
            }
            draw() {
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fillStyle = this.color;
                ctx.globalAlpha = this.opacity;
                ctx.fill();
                ctx.globalAlpha = 1;
            }
        }

        function initParticles() {
            particles = [];
            for (let i = 0; i < 50; i++) particles.push(new Particle());
        }

        function animateParticles() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            particles.forEach(p => { p.update(); p.draw(); });
            requestAnimationFrame(animateParticles);
        }

        window.addEventListener('resize', () => { resizeCanvas(); initParticles(); });
        resizeCanvas();
        initParticles();
        animateParticles();
    </script>
</body>
</html>
