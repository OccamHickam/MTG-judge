<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Veritas - Game Session</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0a0f1a 0%, #1a1f2e 50%, #0f172a 100%);
            color: #e2e8f0;
            min-height: 100vh;
            overflow: hidden;
            position: relative;
        }
        
        /* Animated background particles */
        .particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: hidden;
            z-index: 0;
        }
        
        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: rgba(20, 184, 166, 0.6);
            border-radius: 50%;
            animation: float 15s infinite;
            box-shadow: 0 0 10px rgba(20, 184, 166, 0.4);
        }
        
        .particle:nth-child(1) { left: 10%; animation-delay: 0s; animation-duration: 12s; }
        .particle:nth-child(2) { left: 20%; animation-delay: 1s; animation-duration: 18s; width: 6px; height: 6px; }
        .particle:nth-child(3) { left: 30%; animation-delay: 2s; animation-duration: 14s; }
        .particle:nth-child(4) { left: 40%; animation-delay: 0.5s; animation-duration: 16s; width: 3px; height: 3px; background: rgba(45, 212, 191, 0.5); }
        .particle:nth-child(5) { left: 50%; animation-delay: 3s; animation-duration: 20s; width: 5px; height: 5px; }
        .particle:nth-child(6) { left: 60%; animation-delay: 1.5s; animation-duration: 13s; }
        .particle:nth-child(7) { left: 70%; animation-delay: 2.5s; animation-duration: 17s; width: 4px; height: 4px; background: rgba(20, 184, 166, 0.4); }
        .particle:nth-child(8) { left: 80%; animation-delay: 0s; animation-duration: 19s; width: 6px; height: 6px; }
        .particle:nth-child(9) { left: 90%; animation-delay: 4s; animation-duration: 15s; }
        .particle:nth-child(10) { left: 15%; animation-delay: 2s; animation-duration: 21s; width: 3px; height: 3px; background: rgba(45, 212, 191, 0.6); }
        .particle:nth-child(11) { left: 25%; animation-delay: 5s; animation-duration: 14s; }
        .particle:nth-child(12) { left: 35%; animation-delay: 1s; animation-duration: 18s; width: 5px; height: 5px; }
        .particle:nth-child(13) { left: 45%; animation-delay: 3.5s; animation-duration: 16s; }
        .particle:nth-child(14) { left: 55%; animation-delay: 0.5s; animation-duration: 20s; width: 4px; height: 4px; background: rgba(20, 184, 166, 0.5); }
        .particle:nth-child(15) { left: 65%; animation-delay: 4.5s; animation-duration: 13s; }
        .particle:nth-child(16) { left: 75%; animation-delay: 2.5s; animation-duration: 17s; width: 6px; height: 6px; }
        .particle:nth-child(17) { left: 85%; animation-delay: 1s; animation-duration: 19s; }
        .particle:nth-child(18) { left: 5%; animation-delay: 3s; animation-duration: 15s; width: 3px; height: 3px; }
        .particle:nth-child(19) { left: 95%; animation-delay: 0s; animation-duration: 22s; width: 5px; height: 5px; background: rgba(45, 212, 191, 0.4); }
        .particle:nth-child(20) { left: 50%; animation-delay: 6s; animation-duration: 14s; }
        
        @keyframes float {
            0% { transform: translateY(100vh) rotate(0deg); opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { transform: translateY(-100vh) rotate(720deg); opacity: 0; }
        }
        
        .ambient-glow {
            position: fixed;
            width: 300px;
            height: 300px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(20, 184, 166, 0.15) 0%, transparent 70%);
            pointer-events: none;
            animation: drift 20s infinite ease-in-out;
        }
        
        .ambient-glow:nth-child(1) { top: 20%; left: 20%; animation-delay: 0s; }
        .ambient-glow:nth-child(2) { top: 60%; right: 20%; animation-delay: -10s; background: radial-gradient(circle, rgba(45, 212, 191, 0.1) 0%, transparent 70%); }
        
        @keyframes drift {
            0%, 100% { transform: translate(0, 0) scale(1); }
            25% { transform: translate(50px, -30px) scale(1.1); }
            50% { transform: translate(-30px, 50px) scale(0.9); }
            75% { transform: translate(-50px, -20px) scale(1.05); }
        }
        
        body.recording .particle {
            background: rgba(239, 68, 68, 0.6);
            box-shadow: 0 0 10px rgba(239, 68, 68, 0.4);
        }
        
        body.recording .ambient-glow {
            background: radial-gradient(circle, rgba(239, 68, 68, 0.15) 0%, transparent 70%);
        }
        
        /* UI Elements */
        .back-link {
            position: fixed;
            top: 30px;
            left: 30px;
            color: #64748b;
            text-decoration: none;
            font-size: 0.9rem;
            opacity: 0.5;
            transition: opacity 0.3s;
            z-index: 10;
        }
        .back-link:hover { opacity: 1; color: #14b8a6; }
        
        .status-bar {
            position: fixed;
            top: 30px;
            right: 30px;
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 10;
            background: rgba(15, 23, 42, 0.8);
            padding: 8px 16px;
            border-radius: 20px;
            border: 1px solid #334155;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #22c55e;
            animation: statusPulse 2s infinite;
        }
        
        @keyframes statusPulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
        }
        
        body.recording .status-dot {
            background: #ef4444;
            animation: recordingPulse 1s infinite;
        }
        
        @keyframes recordingPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        
        .status-text {
            color: #64748b;
            font-size: 0.85rem;
        }
        
        /* FULL PLATE ANSWER CARD */
        .answer-plate {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            opacity: 0;
            width: 90%;
            max-width: 600px;
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border: 2px solid #14b8a6;
            border-radius: 20px;
            padding: 0;
            z-index: 100;
            pointer-events: none;
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            box-shadow: 0 25px 80px rgba(0,0,0,0.6), 0 0 40px rgba(20, 184, 166, 0.2);
        }
        
        .answer-plate.active {
            transform: translate(-50%, -50%) scale(1);
            opacity: 1;
            pointer-events: auto;
        }
        
        .plate-header {
            background: linear-gradient(90deg, #14b8a6, #2dd4bf);
            color: #0f172a;
            padding: 20px 25px;
            border-radius: 18px 18px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .plate-header h2 {
            font-size: 1.4rem;
            font-weight: bold;
            margin: 0;
        }
        
        .plate-close {
            background: none;
            border: none;
            color: #0f172a;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.2s;
        }
        
        .plate-close:hover {
            background: rgba(0,0,0,0.1);
        }
        
        .plate-content {
            padding: 25px;
        }
        
        .plate-section {
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #334155;
        }
        
        .plate-section:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }
        
        .plate-section h3 {
            color: #14b8a6;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .plate-section p, .plate-section li {
            color: #e2e8f0;
            line-height: 1.7;
            font-size: 1.05rem;
        }
        
        .plate-section ul {
            margin: 0;
            padding-left: 20px;
        }
        
        .plate-section li {
            margin-bottom: 8px;
        }
        
        .rule-reference {
            display: inline-block;
            background: #334155;
            color: #14b8a6;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.85rem;
            font-family: monospace;
            margin-top: 10px;
        }
        
        .action-box {
            background: rgba(20, 184, 166, 0.1);
            border-left: 4px solid #14b8a6;
            padding: 15px 20px;
            border-radius: 0 8px 8px 0;
            margin-top: 10px;
        }
        
        .action-box strong {
            color: #2dd4bf;
        }
        
        /* Start hint */
        .start-hint {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: #64748b;
            opacity: 0.7;
            pointer-events: none;
            z-index: 5;
        }
        
        .start-hint.hidden {
            opacity: 0;
            transition: opacity 0.5s;
        }
        
        /* Transcript drawer */
        .transcript-toggle {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: rgba(30, 41, 59, 0.9);
            border: 1px solid #334155;
            color: #64748b;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 0.9rem;
            z-index: 10;
            backdrop-filter: blur(10px);
            transition: all 0.3s;
        }
        
        .transcript-toggle:hover {
            color: #14b8a6;
            border-color: #14b8a6;
        }
        
        .transcript-drawer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(15, 23, 42, 0.98);
            border-top: 1px solid #334155;
            transform: translateY(100%);
            transition: transform 0.3s;
            max-height: 50vh;
            overflow-y: auto;
            z-index: 20;
        }
        
        .transcript-drawer.open {
            transform: translateY(0);
        }
        
        .transcript-content {
            padding: 30px;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .transcript-item {
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #334155;
        }
        
        .transcript-time {
            color: #64748b;
            font-size: 0.8rem;
            margin-bottom: 5px;
        }
        
        .transcript-text {
            color: #e2e8f0;
        }
        
        .transcript-text.question {
            color: #14b8a6;
        }
        
        /* End session */
        .end-session {
            position: fixed;
            bottom: 30px;
            left: 30px;
            background: rgba(220, 38, 38, 0.9);
            border: none;
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 0.9rem;
            z-index: 10;
            backdrop-filter: blur(10px);
        }
        
        /* Summary screen */
        .summary-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            transform: translateY(100%);
            transition: transform 0.5s;
            overflow-y: auto;
            padding: 40px;
            z-index: 200;
        }
        
        .summary-screen.active {
            transform: translateY(0);
        }
        
        .summary-content {
            max-width: 800px;
            margin: 0 auto;
        }
        
        .summary-header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .summary-header h2 {
            color: #14b8a6;
            font-size: 2.5rem;
        }
        
        .summary-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .summary-stat {
            background: #1e293b;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
        }
        
        .summary-stat-value {
            font-size: 2.5rem;
            color: #14b8a6;
            font-weight: bold;
        }
        
        .summary-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
        }
        
        button {
            padding: 15px 30px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 1rem;
        }
        
        .btn-primary {
            background: linear-gradient(90deg, #14b8a6, #2dd4bf);
            color: #0f172a;
            font-weight: bold;
        }
        
        .btn-secondary {
            background: #334155;
            color: #e2e8f0;
        }
    </style>
</head>
<body>
    <!-- Animated background -->
    <div class="particles">
        <div class="particle"></div><div class="particle"></div><div class="particle"></div>
        <div class="particle"></div><div class="particle"></div><div class="particle"></div>
        <div class="particle"></div><div class="particle"></div><div class="particle"></div>
        <div class="particle"></div><div class="particle"></div><div class="particle"></div>
        <div class="particle"></div><div class="particle"></div><div class="particle"></div>
        <div class="particle"></div><div class="particle"></div><div class="particle"></div>
        <div class="particle"></div><div class="particle"></div>
    </div>
    <div class="ambient-glow"></div>
    <div class="ambient-glow"></div>
    
    <!-- UI -->
    <a href="index.html" class="back-link">‚Üê Back</a>
    
    <div class="status-bar">
        <div class="status-dot"></div>
        <span class="status-text" id="statusText">Listening...</span>
    </div>
    
    <div class="start-hint" id="startHint">
        <p style="font-size: 1.2rem; margin-bottom: 10px;">üéôÔ∏è Veritas is listening</p>
        <p style="font-size: 0.9rem;">Ask a rules question</p>
    </div>
    
    <!-- FULL ANSWER PLATE -->
    <div class="answer-plate" id="answerPlate">
        <div class="plate-header">
            <h2 id="plateTitle">Rule Clarification</h2>
            <button class="plate-close" onclick="dismissPlate()">√ó</button>
        </div>
        <div class="plate-content">
            <div class="plate-section">
                <h3>üìú The Rule</h3>
                <p id="plateRule">Rule text goes here...</p>
                <span class="rule-reference" id="plateReference">CR 702.11c</span>
            </div>
            
            <div class="plate-section">
                <h3>üí° What This Means</h3>
                <p id="plateExplanation">Explanation goes here...</p>
            </div>
            
            <div class="plate-section">
                <h3>‚úÖ What To Do</h3>
                <div class="action-box">
                    <p id="plateAction">Actionable guidance goes here...</p>
                </div>
            </div>
        </div>
    </div>
    
    <button class="transcript-toggle" onclick="toggleTranscript()">üìù History</button>
    <button class="end-session" onclick="endSession()">End Session</button>
    
    <div class="transcript-drawer" id="transcriptDrawer">
        <div class="transcript-content" id="transcriptContent">
            <p style="color: #64748b; text-align: center;">Ask a question to see the transcript...</p>
        </div>
    </div>
    
    <div class="summary-screen" id="summaryScreen">
        <div class="summary-content">
            <div class="summary-header">
                <h2>üß† Session Complete</h2>
                <p style="color: #64748b;">Here's what we covered</p>
            </div>
            <div class="summary-stats">
                <div class="summary-stat">
                    <div class="summary-stat-value" id="statQuestions">0</div>
                    <div style="color: #64748b; margin-top: 5px;">Questions</div>
                </div>
                <div class="summary-stat">
                    <div class="summary-stat-value" id="statDuration">0:00</div>
                    <div style="color: #64748b; margin-top: 5px;">Duration</div>
                </div>
                <div class="summary-stat">
                    <div class="summary-stat-value" id="statRules">0</div>
                    <div style="color: #64748b; margin-top: 5px;">Rules Explained</div>
                </div>
            </div>
            <div class="summary-actions">
                <button class="btn-secondary" onclick="window.location.href='index.html'">‚Üê Back to Home</button>
                <button class="btn-primary" onclick="location.reload()">üéÆ New Session</button>
            </div>
        </div>
    </div>

    <script>
        let recognition = null;
        let isListening = true;
        let sessionData = {
            transcript: [],
            questions: [],
            startTime: new Date(),
            rulesExplained: 0
        };
        let plateVisible = false;

        const questionPatterns = [
            /can i/i, /can you/i, /can we/i, /does/i, /do /i, /is /i, /are /i,
            /how does/i, /what happens/i, /what if/i, /wait/i, /hold on/i,
            /target/i, /respond/i, /trigger/i, /stack/i,
            /hexproof/i, /flying/i, /trample/i, /indestructible/i,
            /commander/i, /combat/i, /attack/i, /block/i
        ];

        const rulesDatabase = {
            'hexproof': {
                title: 'Hexproof',
                rule: 'A permanent with hexproof can\'t be targeted by spells or abilities your opponents control.',
                reference: 'CR 702.11c',
                explanation: 'This means your opponents cannot choose your hexproof creature as a target for their spells or abilities. However, hexproof does NOT protect against board wipes (like "destroy all creatures"), sacrifice effects, or spells that don\'t target.',
                action: 'Your creature is safe from targeted removal like Doom Blade or Path to Exile, but watch out for board wipes like Wrath of God or "sacrifice a creature" effects.'
            },
            'trample': {
                title: 'Trample',
                rule: 'When a creature with trample assigns combat damage, it must assign lethal damage to all blocking creatures before assigning excess damage to the defending player.',
                reference: 'CR 702.19b',
                explanation: 'If a 5/5 with trample is blocked by a 2/2, only 2 damage is needed to kill the blocker. The remaining 3 damage "tramples over" and hits the defending player or planeswalker.',
                action: 'When blocking a trampler, consider whether chump-blocking (sacrificing a small creature to prevent some damage) is better than taking the full hit.'
            },
            'flying': {
                title: 'Flying',
                rule: 'A creature with flying can\'t be blocked except by creatures with flying or reach.',
                reference: 'CR 702.9b',
                explanation: 'Flying creates an evasion ability. Ground creatures without reach cannot block flyers, making them difficult to stop in combat.',
                action: 'If you have flyers, attack freely unless they have flyers/reach. If facing flyers, you need either flying creatures, reach creatures, or removal spells.'
            },
            'indestructible': {
                title: 'Indestructible',
                rule: 'A permanent with indestructible can\'t be destroyed by damage or effects that say "destroy."',
                reference: 'CR 702.12b',
                explanation: 'Indestructible creatures survive lethal damage and board wipes. However, they can still be exiled, sacrificed, returned to hand, or have toughness reduced to 0.',
                action: 'Don\'t waste "destroy" effects on indestructible creatures. Use exile, bounce, -X/-X effects, or force them to be sacrificed instead.'
            },
            'commander tax': {
                title: 'Commander Tax',
                rule: 'Each time you cast your commander from the command zone, it costs {2} more for each previous time you\'ve cast it from the command zone this game.',
                reference: 'CR 903.8',
                explanation: 'First cast: normal cost. Second cast: +{2}. Third cast: +{4}. This tax accumulates for the rest of the game.',
                action: 'Protect your commander once it\'s on the board ‚Äî returning it to hand or keeping it safe is often better than letting it die and paying the tax again.'
            },
            'commander damage': {
                title: 'Commander Damage',
                rule: 'A player loses the game if they\'ve been dealt 21 or more combat damage by the same commander.',
                reference: 'CR 903.10a',
                explanation: 'This is tracked per commander. If one commander deals you 21 damage, you lose. Damage from multiple different commanders doesn\'t combine.',
                action: 'Track commander damage carefully. If someone is at 15+ damage from one commander, they\'re in lethal range. Prioritize blocking or removing that commander.'
            },
            'the stack': {
                title: 'The Stack',
                rule: 'The stack is the zone where spells and abilities wait to resolve. The last spell/ability put on the stack resolves first (LIFO).',
                reference: 'CR 405.1',
                explanation: 'When you cast a spell, it goes on the stack. Players can respond by adding more spells/abilities. Once everyone passes, the top item resolves, then players can respond again.',
                action: 'You can respond to almost everything. Wait for your opponent to cast something, then respond with your counterspell or instant. Remember: last in, first out.'
            },
            'priority': {
                title: 'Priority',
                rule: 'The active player receives priority first. After they pass, the non-active player receives priority.',
                reference: 'CR 117.1',
                explanation: 'Priority determines who can cast spells and activate abilities. You can only do things when you have priority, or when casting an instant/activating an ability in response.',
                action: 'If you want to do something at a specific time, you need priority. The active player controls the pace, but you can respond to their actions.'
            },
            'target': {
                title: 'Targeting',
                rule: 'When you cast a spell or activate an ability that targets, you must choose legal targets. If all targets become illegal, the spell is countered.',
                reference: 'CR 115.1',
                explanation: 'Hexproof and shroud prevent targeting. Once targets are chosen, the spell remembers them. If the target gains hexproof later, the spell is countered on resolution.',
                action: 'Check if your target is legal before casting. If they have hexproof, you can\'t target them. You can respond to their spell by giving your creature hexproof to counter their spell.'
            },
            'trigger': {
                title: 'Triggered Abilities',
                rule: 'When a triggered ability\'s condition is met, it goes on the stack the next time a player receives priority.',
                reference: 'CR 603.2',
                explanation: 'Triggers use the stack and can be responded to. In multiplayer, triggers go on the stack in APNAP order: Active Player, then Non-Active Players in turn order.',
                action: 'Don\'t miss your triggers ‚Äî they\'re mandatory if they don\'t say "may." You can respond to triggers before they resolve, and in multiplayer, the order matters.'
            },
            'default': {
                title: 'Rules Question',
                rule: 'The specific rule depends on your exact situation.',
                reference: 'Comprehensive Rules',
                explanation: 'I heard your question but need more context to give you the precise rule. Try asking about a specific keyword ability or game concept.',
                action: 'For the most accurate answer, mention specific cards or abilities. You can also check the official Comprehensive Rules or ask a judge for complex interactions.'
            }
        };

        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = 'en-US';

            recognition.onresult = (event) => {
                const results = event.results;
                const lastResult = results[results.length - 1];
                const transcript = lastResult[0].transcript;
                
                if (lastResult.isFinal) {
                    processTranscript(transcript);
                }
            };

            recognition.onerror = (event) => {
                if (event.error === 'no-speech') return;
                setTimeout(() => { if (isListening) recognition.start(); }, 1000);
            };

            recognition.onend = () => {
                if (isListening) recognition.start();
            };

            recognition.start();
        }

        function processTranscript(text) {
            const timestamp = new Date().toLocaleTimeString();
            const entry = { time: timestamp, text: text, isQuestion: false };
            
            const isQuestion = questionPatterns.some(pattern => pattern.test(text));
            
            if (isQuestion) {
                entry.isQuestion = true;
                sessionData.questions.push(entry);
                
                document.body.classList.add('recording');
                document.getElementById('statusText').textContent = 'Processing...';
                
                const answer = findAnswer(text);
                sessionData.rulesExplained++;
                showPlate(answer);
                
                setTimeout(() => {
                    document.body.classList.remove('recording');
                    document.getElementById('statusText').textContent = 'Listening...';
                }, 2000);
                
                document.getElementById('startHint').classList.add('hidden');
            }
            
            sessionData.transcript.push(entry);
            updateTranscript();
        }

        function findAnswer(text) {
            const lower = text.toLowerCase();
            for (const [keyword, data] of Object.entries(rulesDatabase)) {
                if (lower.includes(keyword)) {
                    return data;
                }
            }
            return rulesDatabase['default'];
        }

        function showPlate(answer) {
            document.getElementById('plateTitle').textContent = answer.title;
            document.getElementById('plateRule').textContent = answer.rule;
            document.getElementById('plateReference').textContent = answer.reference;
            document.getElementById('plateExplanation').textContent = answer.explanation;
            document.getElementById('plateAction').textContent = answer.action;
            
            document.getElementById('answerPlate').classList.add('active');
            plateVisible = true;
        }

        function dismissPlate() {
            document.getElementById('answerPlate').classList.remove('active');
            plateVisible = false;
        }

        function updateTranscript() {
            const content = document.getElementById('transcriptContent');
            if (content.innerHTML.includes('Ask a question')) {
                content.innerHTML = '';
            }
            
            const entry = sessionData.transcript[sessionData.transcript.length - 1];
            const div = document.createElement('div');
            div.className = 'transcript-item';
            div.innerHTML = `
                <div class="transcript-time">${entry.time}</div>
                <div class="transcript-text ${entry.isQuestion ? 'question' : ''}">${entry.text}</div>
            `;
            content.insertBefore(div, content.firstChild);
        }

        function toggleTranscript() {
            document.getElementById('transcriptDrawer').classList.toggle('open');
        }

        function endSession() {
            isListening = false;
            if (recognition) recognition.stop();
            
            const duration = Math.floor((new Date() - sessionData.startTime) / 1000);
            const minutes = Math.floor(duration / 60);
            const seconds = duration % 60;
            
            document.getElementById('statQuestions').textContent = sessionData.questions.length;
            document.getElementById('statDuration').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            document.getElementById('statRules').textContent = sessionData.rulesExplained;
            
            let sessions = JSON.parse(localStorage.getItem('veritas_sessions') || '[]');
            sessions.push({
                ...sessionData,
                endTime: new Date().toISOString(),
                duration: duration
            });
            localStorage.setItem('veritas_sessions', JSON.stringify(sessions));
            
            document.getElementById('summaryScreen').classList.add('active');
        }

        // Close plate on background click
        document.addEventListener('click', (e) => {
            if (plateVisible && !e.target.closest('.answer-plate')) {
                dismissPlate();
            }
        });
    </script>
</body>
</html>
